# 动态定位 (Dynamic Positioning) 功能详解

动态定位功能允许用户为模板中的识别区域设定**相对参照点（锚点）**，而非仅仅依赖绝对坐标。这使得模板即使在文档发生位移、缩放或内容略微变动时，仍能精确锁定目标区域。

## 1. 核心概念

传统的模板区域通常使用固定的 `(x, y, width, height)` 坐标。当扫描件歪斜或格式微调时，固定坐标容易失效。

**动态定位**引入了以下概念：
- **锚点 (Anchor)**：一个相对稳定的参考物（如某个固定的标题文字 "发票号码"）。
- **偏移量 (Offset)**：目标区域相对于锚点的距离 `(offset_x, offset_y)`。
- **边界模式 (Boundary Mode)**：确定区域大小的方式（固定大小或根据两个锚点动态拉伸）。

## 2. 前端交互机制 (Frontend)

在前端编辑器中，动态定位通过直观的视觉交互实现：

### 开启方式
在顶部工具栏点击 **锚点图标 (Anchor Button)** 开启“动态定位模式”。

### 交互流程
1. **视觉提示**：选中区域的四个角会出现“呼吸”动画的圆形锚点，提示可进行交互。
2. **建立关联**：
   - 用户按住某个角的锚点拖拽。
   - 鼠标拖出一条虚线，指向当前悬停的**文本元素 (OCR Word)**。
   - 被选中的文字会高亮显示（红色边框）。
3. **确认定位**：
   - 松开鼠标后，系统会呈现“闪烁”动画，确认锚定成功。
   - 用于定位的文字会出现**蓝色虚线框**。
   - 原始区域的角与该文字之间建立了一条连接线。
4. **微调**：
   - 用户可以拖动锚点手柄，调整区域相对于基准文字的精确偏移位置。

*注意：目前前端 UI 主要实现了基于**文本 (Text)** 的动态锚定。*

## 3. 后端实现逻辑 (Backend)

后端核心逻辑位于 `backend/positioning.py`。

### 坐标解析流程 (`resolve_region_bounds`)
当处理一个开启了动态定位的区域时，系统不再直接使用存储的 `x, y`，而是动态计算：

1. **解析锚点 (`resolve_anchor`)**：
   - 根据配置的定位器 (`anchor_locator`) 找到参考点。
   - **Text 模式**：调用 `find_text_position`，在页面上搜索匹配的文字内容（支持正则或字符串匹配），返回该文字的中心坐标 `(ax, ay)`。
   - **Fixed/Relative 模式**：也支持绝对坐标或百分比作为备选基准。
   - **Image 模式**：(代码库中存在支持) 通过 OpenCV 模板匹配找到特定的图标或图像标记位置。

2. **计算目标位置**：
   - 目标坐标 = 锚点坐标 + 偏移量
   - `target_x = anchor_x + offset_x`
   - `target_y = anchor_y + offset_y`

3. **确定区域尺寸 (`resolve_boundary`)**：
   - **Adjacent 模式**：基于解析出的起点，向右/向下延伸固定的宽度和高度（或根据另一个参照物确定终点）。
   - **Diagonal 模式**：如果配置了对角锚点，系统会分别解析左上角和右下角的锚点，然后动态计算出两者之间的区域。这允许区域随内容的增减而自动伸缩（例如：列表区域随行数变化）。

## 4. 常见问题与鲁棒性 (FAQ & Robustness)

关于您提到的几个具体问题，以下是技术层面的详细解答：

### Q1: 如果页面中有多个相同的文本（例如多个 "日期"），会不会出错？
**A: 会有风险，建议选择唯一文本。**
- **当前机制**：目前系统默认会匹配页面上**第一个**出现的符合条件的文本。
- **潜在问题**：如果您将锚点绑定到了页面下方的第二个“日期”，但系统在处理新文件时搜索到了页面上方的第一个“日期”，定位就会发生巨大偏差。
- **建议**：尽量选择**全局唯一**的标题文本（如“发票号码”、“合计金额”等）作为锚点，避免使用重复出现的通用词汇。
- *技术注*：后端架构 (`AnchorLocator`) 实际上支持 `text_match_index` (指定第 N 个匹配项) 和 `search_area` (限制搜索范围)，但目前前端交互尚未暴露这些高级配置，默认只取第一个。

### Q2: 如何在类似 PDF 中定位？如果有位置偏差怎么办？
**A: 通过内容搜索自动适应偏差。**
- **定位原理**：系统不是靠“猜”位置，而是**实时搜索**。处理新 PDF 时，系统会遍历全页文本，寻找与您设定的锚点内容一致的文字（例如找到 "Total:" 这个词）。
- **适应性**：不管 "Total:" 这个词相对于原模板移动了多少（只要还在页面上），系统都能找到它，然后根据您保存的相对偏移量 (`offset_x`, `offset_y`) 重新计算识别区域的位置。这就是“动态”的核心意义。

### Q3: 扫描件分辨率不同或页面规格微调有影响吗？
**A: 基本无影响，系统使用归一化坐标。**
- **归一化处理**：系统内部存储和计算的所有坐标都是 `0.0 ~ 1.0` 的相对比例值，而不是绝对像素值。
- **分辨率无关**：一张 `1000x1000` 的图片和 `2000x2000` 的图片，中心点的坐标都是 `(0.5, 0.5)`。因此，单纯的分辨率变化不会影响定位精度。
- **长宽比变化**：只有当页面的**长宽比**发生剧烈变化（如从 A4 变为 Letter，被非等比拉伸）时，可能会产生轻微的相对位置偏移，但通常在可接受的高容差范围内。

## 总结

该功能通过将**绝对坐标**转化为**相对于稳定特征的相对坐标**，极大地提高了模板在复杂真实场景下的适应性和鲁棒性。

- **前端**负责提供所见即所得的交互，让用户通过简单的拖拽将“区域角点”绑定到“固定文字”上。
- **后端**在运行时实时搜索这些文字，并根据保存的偏移量重建精确的识别区域。
