# 版面分析重构计划 (Layout Analysis Refactor Plan)

本计划旨在重构项目的版面分析模块，移除对 YOLO 深度学习模型的依赖，转而采用更轻量、可控的启发式（基于规则）算法来实现文档结构识别。这将提高系统的运行效率，降低部署复杂度，并提供更可解释的分析结果。

**当前分支**: `feat/heuristic-layout-analysis` (已创建)

---

## Phase 2: 启发式版面分析算法开发 (后端)

本阶段专注于后端 Python 代码的重构，构建一套全新的文档布局分析引擎。

### 1. 基础设施搭建
- [ ] **创建模块结构**: 在 `backend/` 下新建 `layout_analysis/` 包，用于存放所有相关代码。
- [ ] **定义数据结构**: 设计 `TextSpan`, `TextLine`, `TextBlock`, `TableRegion` 等核心类，用于标准化中间处理结果。
- [ ] **PDF 解析器封装**: 封装 `pdfplumber` 或 `pymupdf`，用于稳定获取页面原始字符流（CharStream）和基础绘图对象（Lines, Rects）。

### 2. 文本流处理算法
- [ ] **行合并 (Line Merging)**: 开发算法将分散的字符根据 Y 坐标和水平间距合并为文本行。
- [ ] **可以阅读顺序排序**: 对文本行进行 XY 排序，确保符合人类阅读顺序。
- [ ] **段落合并 (Paragraph Merging)**: 根据行间距、字体大小、缩进等特征，将文本行聚类为段落（Block）。

### 3. 表格检测算法 (核心难点)
- [ ] **显式表格识别**: 基于 PDF 中的线条（Lining）信息，重构表格结构（行/列单元格）。
- [ ] **隐式表格识别**: 开发投影算法（Projection Profile）或空白间隙检测算法（Whitespace Analysis），识别没有边框的隐式表格布局。
- [ ] **表格结构化**: 将识别到的表格区域解析为结构化的 Row/Col 数据。

### 4. API 适配
- [ ] **创建新端点**: 新增 `/api/v2/analyze` 或在现有接口中增加 `engine='heuristic'` 参数。
- [ ] **结果标准化**: 确保新算法输出的 JSON 格式与前端 `DocumentEditor` 组件所需的格式兼容（regions, tables 等）。

---

## Phase 3: 前端集成与系统验证

本阶段将前端切换至新算法，验证效果并清理旧代码。

### 1. 前端对接
- [ ] **API 调用更新**: 修改 `frontend/` 中的 API 调用逻辑，默认使用新的版面分析引擎。
- [ ] **可视化调试**: 在前端增加“调试模式”，可查看算法识别到的原始 Block 边界（不仅仅是最终的提取结果），用于排查算法问题。

### 2. 验证与调优
- [ ] **基准测试**: 使用一组典型 PDF（包含发票、清单、多栏文档）进行测试。
- [ ] **Corner Case 处理**: 针对识别错误的案例（如页眉页脚干扰、水印干扰）进行算法微调。

### 3. 清理工作 (YOLO 移除)
- [ ] **移除模型文件**: 删除 `backend/models/` 下的 YOLO `.pt` 或 `.onnx` 文件。
- [ ] **清理依赖**: 从 `pyproject.toml` 或 `requirements.txt` 中移除 `ultralytics`, `torch` (如果不需要) 等沉重依赖。
- [ ] **代码清理**: 删除旧的 `yolo_service.py` 及相关胶水代码。

---

## 执行策略
1.  **保持主分支稳定**: 所有开发仅在 `feat/heuristic-layout-analysis` 分支进行。
2.  **增量提交**: 每个具体的算法功能（如“行合并完成”）都应有独立的 Commit。
3.  **单元测试**: 为核心几何算法编写简单的单元测试，确保逻辑正确。
