name: Build Desktop App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            artifact_name: IndustryPDF-macOS
            zip_name: IndustryPDF-macOS.zip
          - os: windows-latest
            artifact_name: IndustryPDF-Windows
            zip_name: IndustryPDF-Windows.zip
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install uv
        if: runner.os == 'Windows'
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          version: "latest"

      - name: Install Python dependencies
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            cd backend
            uv sync
          else
            python -m pip install --upgrade pip
            pip install fastapi huggingface-hub numpy onnxruntime opencv-python-headless pdfplumber pillow pydantic-settings pymupdf python-multipart rapidocr-onnxruntime uvicorn pywebview pyinstaller
          fi
      
      - name: Build Frontend
        working-directory: frontend
        shell: bash
        run: |
          npm install && npm run build
      
      - name: Verify Frontend Build
        shell: bash
        run: |
          if [ -d "frontend/dist" ]; then
              echo "Frontend build verified."
              ls frontend/dist
          else
              echo "Frontend dist directory NOT found!"
              exit 1
          fi
      
      - name: Download Model Files
        shell: bash
        env:
          HF_ENDPOINT: https://hf-mirror.com
        run: |
          mkdir -p backend/data/models/ocr
          python -c "
          from huggingface_hub import hf_hub_download
          import os
          import shutil
          
          # 1. Download YOLO model (from verified source)
          print('Downloading YOLO model...')
          yolo_path = hf_hub_download(
              repo_id='wybxc/DocLayout-YOLO-DocStructBench-onnx', 
              filename='doclayout_yolo_docstructbench_imgsz1024.onnx', 
              local_dir='backend/data/models', 
              local_dir_use_symlinks=False
          )
          # Rename to what the code expects: yolov10-doclayout.onnx
          shutil.move(yolo_path, os.path.join('backend/data/models', 'yolov10-doclayout.onnx'))
          
          # 2. Download OCR models (from verified source)
          ocr_repo = 'SWHL/RapidOCR'
          ocr_files = ['ch_PP-OCRv4_det_infer.onnx', 'ch_PP-OCRv4_rec_infer.onnx']
          for f in ocr_files:
              print(f'Downloading OCR model {f}...')
              hf_hub_download(
                  repo_id=ocr_repo, 
                  filename=f'PP-OCRv4/{f}', 
                  local_dir='backend/data/models/ocr', 
                  local_dir_use_symlinks=False
              )
              # hf_hub_download with local_dir + subpath creates a subfolder. Move file to root of /ocr
              src = os.path.join('backend/data/models/ocr', 'PP-OCRv4', f)
              dst = os.path.join('backend/data/models/ocr', f)
              if os.path.exists(src):
                  shutil.move(src, dst)
          "

      - name: Convert Icons
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            uv run --project backend python backend/scripts/convert_icons.py
          else
            python backend/scripts/convert_icons.py
          fi

      - name: Build Desktop App
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            uv run --project backend pyinstaller industry_pdf.spec --clean --noconfirm
          else
            python -m PyInstaller industry_pdf.spec --clean --noconfirm
          fi
      
      - name: Compress App Bundle (macOS)
        if: runner.os == 'macOS'
        run: |
          cd dist
          zip -r ../${{ matrix.zip_name }} InvoMaster.app
      
      - name: Compress App Folder (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path "dist\InvoMaster" -DestinationPath "${{ matrix.zip_name }}"
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.zip_name }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: List artifacts
        run: ls -R
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            IndustryPDF-macOS/IndustryPDF-macOS.zip
            IndustryPDF-Windows/IndustryPDF-Windows.zip
          draft: false
          prerelease: false
          generate_release_notes: true
          token: ${{ secrets.GITHUB_TOKEN }}
