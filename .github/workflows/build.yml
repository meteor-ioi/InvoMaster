name: Build Desktop App

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            artifact_name: IndustryPDF-macOS
            zip_name: IndustryPDF-macOS.zip
          - os: windows-latest
            artifact_name: IndustryPDF-Windows
            zip_name: IndustryPDF-Windows.zip
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Install uv
        if: runner.os == 'Windows'
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          version: "latest"

      - name: Install Python dependencies
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            cd backend
            uv sync
          else
            python -m pip install --upgrade pip
            pip install fastapi huggingface-hub numpy onnxruntime opencv-python-headless pdfplumber pillow pydantic-settings pymupdf python-multipart rapidocr-onnxruntime uvicorn pywebview pyinstaller
          fi
      
      - name: Build Frontend
        working-directory: frontend
        shell: bash
        run: |
          npm install && npm run build
      
      - name: Verify Frontend Build
        shell: bash
        run: |
          if [ -d "frontend/dist" ]; then
              echo "Frontend build verified."
              ls frontend/dist
          else
              echo "Frontend dist directory NOT found!"
              exit 1
          fi
      
      - name: Download Model Files
        shell: bash
        env:
          HF_ENDPOINT: https://hf-mirror.com
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            uv run --project backend python backend/scripts/download_models.py
          else
            python backend/scripts/download_models.py
          fi

      - name: Convert Icons
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            uv run --project backend python backend/scripts/convert_icons.py
          else
            python backend/scripts/convert_icons.py
          fi

      - name: Build Desktop App
        shell: bash
        run: |
          if [ "${{ runner.os }}" == "Windows" ]; then
            uv run --project backend pyinstaller industry_pdf.spec --clean --noconfirm
          else
            python -m PyInstaller industry_pdf.spec --clean --noconfirm
          fi
      
      - name: Compress App Bundle (macOS)
        if: runner.os == 'macOS'
        run: |
          cd dist
          zip -r ../${{ matrix.zip_name }} InvoMaster.app
      
      - name: Compress App Folder (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Compress-Archive -Path "dist\InvoMaster" -DestinationPath "${{ matrix.zip_name }}"
      
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ matrix.zip_name }}

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: List artifacts
        run: ls -R
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            IndustryPDF-macOS/IndustryPDF-macOS.zip
            IndustryPDF-Windows/IndustryPDF-Windows.zip
          draft: false
          prerelease: false
          generate_release_notes: true
          token: ${{ secrets.GITHUB_TOKEN }}
